---
title: Consul服务发现的配置
published: true
---

Consul如上一篇文件介绍那样一帮用于服务发现和健康检查，在本篇中简单搭建Consul服务发现的测试环境，有利于在微服务框架中使用Consul。

1、首先安装Consul，根据系统的不同到官方地址下载安装文件，自己在Ubuntu下载zip文件解压，移动到bin目录下，表示Consul安装完成，可以直接运行Consul检查时候安装成功

2、单机本地运行
consul agent -dev  #这个命令就会启动Consul，Ctrl+C终止
在本地别的terminal执行
consul members #查看当前运行的节点
Node       Address          Status  Type    Build  Protocol  DC   Segment
agent-one  172.17.0.2:8301  alive   server  1.5.0  2         dc1  all

curl localhost:8500/v1/catalog/nodes
这个命令通过url查看节点的信息

dig @127.0.0.1 -p 8600 agent-one.node.consul
这个命令查看DNS信息

终止Consul有两种方式，一种是Ctrl+C，这种方式比较友好，能够马上从节点里面小时
还有一种方式是kill，这种方式则会启动健康检查那一套机制离开

3、注册服务
通过配置文件
新建consul.d文件夹
echo '{"service": {"name": "web", "tags": ["rails"], "port": 80}}' > ./consul.d/web.json
consul agent -dev -config-dir=./consul.d #这会注册名为web的服务

通过DNS查询dig @127.0.0.1 -p 8600 web.service.consul 则会知道IP
dig @127.0.0.1 -p 8600 web.service.consul SRV 则会只掉本地域名

Http的方式为 curl http://localhost:8500/v1/catalog/service/web

4、集群部署
本地准备两个ubuntu docker
docker1 172.17.0.2
docker2 172.17.0.3

docker1$ consul agent -server -bootstrap-expect=1 -data-dir=/tmp/consul -node=agent-one -bind=172.17.0.2 -enable-script-checks=true -config-dir=/etc/consul.d

docker2$ consul agent -data-dir=/tmp/consul -node=agent-two -bind=172.17.0.3 -enable-script-checks=true -config-dir=/etc/consul.d

docker1$ consul join 172.17.0.3

docker1$ consul members  #则会看到启动的两个节点一个为server一个为client

docker1$ curl http://localhost:8500/v1/catalog/service/web  #则可以看到web服务有两个节点


5、其他继续摸索中


文本你可以**加粗**, _斜体_, 和~~删除~~ 或者`关键字`

[也可以加个链接](www.baidu.com)

# [](#header-1)标题一

## [](#header-2)标题二

> 这是一个块引用
>
> 足够重要的事都可以加块引用

### [](#header-3)标题三

```js
// Js 代码高亮展示
var fun = function lang(l) {
  dateformat.i18n = require('./lang/' + l)
  return true;
}
```

```ruby
# Ruby 代码高亮展示
GitHubPages::Dependencies.gems.each do |gem, version|
  s.add_dependency(gem, "= #{version}")
end
```

#### [](#header-4)标题四

*   这是一个无序列表
*   这是一个无序列表
*   这是一个无序列表

##### [](#header-5)标题五

1.  这是一个有序列表
2.  这是一个有序列表
3.  这是一个有序列表

###### [](#header-6)标题六

| head1        | head two          | three |
|:-------------|:------------------|:------|
| ok           | good swedish fish | nice  |
| out of stock | good and plenty   | nice  |
| ok           | good `oreos`      | hmm   |
| ok           | good `zoute` drop | yumm  |

### 下面是一个分割线

* * *

### 下面是一个无序列表:

*   Item foo
*   Item bar
*   Item baz
*   Item zip

### 下面是一个有序列表:

1.  Item one
1.  Item two
1.  Item three
1.  Item four

### 下面是一个嵌套的列表

- level 1 item
  - level 2 item
  - level 2 item
    - level 3 item
    - level 3 item
- level 1 item
  - level 2 item
  - level 2 item
  - level 2 item
- level 1 item
  - level 2 item
  - level 2 item
- level 1 item

### 小图

![](https://assets-cdn.github.com/images/icons/emoji/octocat.png)

### 大图

![](https://guides.github.com/activities/hello-world/branching.png)


### 使用HTML语义定义列表

<dl>
<dt>Name</dt>
<dd>Godzilla</dd>
<dt>Born</dt>
<dd>1952</dd>
<dt>Birthplace</dt>
<dd>Japan</dd>
<dt>Color</dt>
<dd>Green</dd>
</dl>

```
很长的单行代码块，不应该折叠。而是可以拉动，足够长的行才可以拉动，太短的不行，下面那条就是太短
```

```
太短的代码块
```
